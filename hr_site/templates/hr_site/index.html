{# hr_site/templates/hr_site/index.html #}

{% extends "hr_site/base.html" %}
{% load static %}

{% block title %}Hella Reptilian — Home{% endblock %}

{% block content %}

    <div id="section-wipe-0" class="section-wipe z-20 absolute" style="background-image: url('{% static "hr_site/img/wipe/bryan-goff-we1ky8_ZTHg-unsplash.jpg" %}');"></div>

    <section id="parallax-section-shows" class="parallax-section relative flex items-center justify-center min-h-vhfix">
        <div class="parallax-background absolute inset-0 bg-cover bg-center"></div>
        <div class="parallax-content relative isolate z-10 mx-auto max-w-6xl px-5 py-vh-18 text-center flex flex-col items-center justify-center min-h-vhfix bg-transparent">
            <h1>Upcoming Shows</h1>

            {% if shows %}
                {% for show in shows %}
                    {% if forloop.first %}
                        <div class="concert-card">
                            <div class="card-left date-panel" aria-label="Show date, time, and venue">
                                <div class="date-block">
                                    <div class="month">
                                        {{ show.date|date:"M"|upper }}
                                    </div>
                                    <div class="dowday">
                                        <span class="dow">{{ show.date|date:"D"|upper }}</span>
                                        <span class="day">{{ show.date|date:"j" }}</span>
                                    </div>
                                    <div class="time">
                                        {{ show.time|time:"g:i A" }}
                                    </div>
                                    <div class="venue">
                                        {{ show.venue.name }}
                                    </div>
                                </div>
                            </div>

                            <div class="card-center">
                                <div class="acts">
                                    {% for act in show.lineup.all %}
                                        <div class="act-name">{{ act.name }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="card-right">
                                {% if show.venue.address %}
                                    {% with addr=show.venue.address %}
                                        <a class="card-button"
                                           href="https://www.google.com/maps/search/?api=1&query={{ addr.street_address }} {{ addr.city }} {{ addr.subdivision }} {{ addr.postal_code }}|urlencode"
                                           target="_blank" rel="noopener">
                                            <i class="fas fa-map-marked-alt"></i> Directions
                                        </a>
                                    {% endwith %}
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        {% include "hr_live/_concert_card.html" with show=show %}
                    {% endif %}
                {% endfor %}
            {% else %}
                <p class="opacity-70 italic">
                    No upcoming shows at the moment. Check back soon!
                </p>
            {% endif %}
        </div>
    </section>

    <div id="section-wipe-1" class="section-wipe z-20 absolute"></div>

    <section id="parallax-section-merch" class="parallax-section relative flex items-center justify-center min-h-vhfix">
        <div class="parallax-background absolute inset-0 bg-cover bg-center"></div>
        <div class="parallax-content relative isolate z-10 mx-auto max-w-6xl px-5 py-vh-18 text-center flex flex-col items-center justify-center min-h-vhfix bg-transparent">
            <h1>Merch</h1>

            <div id="merch-grid" class="merch-grid">
                {% for product in products %}
                    <article class="merch-card" data-product-slug="{{ product.slug }}">
                        <button class="merch-img"
                                aria-label="Open details for {{ product.name }}"

                                hx-get="{% url 'hr_shop:get_product_modal_partial' product_slug=product.slug %}"
                                hx-target="#modal-content"
                                hx-swap="innerHTML"
                                hx-on::after-request="document.getElementById('modal').classList.remove('hidden');
                                                      document.getElementById('modal').setAttribute('aria-hidden', 'false');">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}">
                            {% else %}
                                <img src="{% static 'hr_shop/img/merch/placeholder.png' %}" alt="{{ product.name }}">
                            {% endif %}
                        </button>

                        <div class="merch-meta">
                            <h3 class="merch-title">{{ product.name }}</h3>
                            <div class="merch-price">
                                {% if product.min_variant_price %}
                                    From ${{ product.min_variant_price }}
                                {% else %}
                                    Price TBD
                                {% endif %}
                            </div>
                        </div>

                        <div class="merch-actions">
                            <button class="card-button outline"
                                    hx-get="{% url 'hr_shop:product_modal_partial' product_slug=product.slug  %}"
                                    hx-target="#modal-content"
                                    hx-swap="innerHTML"
                                    hx-on::after-request="document.getElementById('modal').classList.remove('hidden');
                                                          document.getElementById('modal').setAttribute('aria-hidden', 'false');">
                                <i class="fas fa-circle-info"></i> Details
                            </button>
                        </div>
                    </article>
                {% empty %}
                    <p>No merch available yet. Check back soon.</p>
                {% endfor %}
            </div>

        </div>
    </section>

    <div id="section-wipe-2" class="section-wipe z-20 absolute"></div>

    <section id="parallax-section-about" class="parallax-section relative flex items-center justify-center min-h-vhfix">
        <div class="parallax-background absolute inset-0 bg-cover bg-center"></div>

        <div class="parallax-content relative isolate z-10 mx-auto max-w-6xl px-5 py-vh-18 text-center flex flex-col items-center justify-center min-h-vhfix bg-transparent">
            <h1>About</h1>
            <div class="about-card">
                <div class="about">
                    <div class="about-intro">
                        <p>
                            Not too long ago, in a place pretty close by, Animals as Leaders and Mastadon had united in
                            getting absolutely annihilated. Though many
                            There is none who can clearly answer any of the great 'W' questions, but from this was born
                            a
                            love-child,
                            known by the name of Hella Reptilian!
                        </p>
                    </div>

                    <div id="about-carousel-container"
                         hx-get="{% url 'hr_about:get_carousel_partial' %}"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <div class="about-gallery loading-state">
                            <p>Loading photos</p>
                        </div>
                    </div>

                </div>
            </div>

            <div class="about-quote-wrap">
                <div class="about-fade-bridge" aria-hidden="true"></div>
                <div id="about-quotes-container"
                     hx-get="{% url 'hr_about:get_quotes_partial' %}"
                     hx-trigger="load"
                     hx-swap="innerHTML">

                    <div class="about-quotes loading-state">
                        <div class="about-quote-rotator">
                            <p class="quote-text">Loading quotes...</p>
                            <p class="quote-source"></p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <div id="section-wipe-3" class="section-wipe z-20 absolute"></div>

    <section id="parallax-section-bulletin"
             class="parallax-section relative flex items-center justify-center min-h-vhfix">
        <div class="parallax-background absolute inset-0 bg-cover bg-center"></div>
        <div class="parallax-content relative isolate z-10 mx-auto px-0 py-vh-18 text-center flex flex-col items-center justify-center min-h-vhfix bg-transparent">
            <h1>Bulletin</h1>
            <div id="bulletin-root"
                 class="bulletin-root"
                 hx-get="{% url 'hr_bulletin:bulletin_list_partial' %}"
                 hx-trigger="load"
                 hx-target="#bulletin-root"
                 hx-swap="innerHTML">
                <p class="bulletin-loading">Loading posts...</p>
            </div>
        </div>
    </section>

{% endblock content %}

{% block extra_scripts %}

    {# about data for quote rotator (only needed on this page) #}
    {% get_static_prefix as sp %}
    <script id="about-data" type="application/json">
    [
      {"src": "{{ sp }}hr_site/img/about/HR_AMST_1.JPG", "alt": "Hammer of the Deep",         "quote": "\"You are audible!\"",                                      "source": "William Murderface"},
      {"src": "{{ sp }}hr_site/img/about/HR_AMST_2.JPG", "alt": "Herald of the Maw",          "quote": "\"Some of my finest work, honestly I might have peaked.\"", "source": "God"},
      {"src": "{{ sp }}hr_site/img/about/HR_AMST_3.JPG", "alt": "Architect of the Maelstrom", "quote": "\"They sang as they slew.\"",                               "source": "J.R.R. Tolkien"},
      {"src": "{{ sp }}hr_site/img/about/HR_AMST_4.JPG", "alt": "Breaker of the Sky",         "quote": "\"These guys fucking rock!\"",                              "source": "Mr. Rogers"}
    ]
    </script>

    <script src="{% static 'hr_site/index.js' %}"></script>

    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            const dataEl = document.getElementById('about-data');
            if (!dataEl) return;

            let items;
            try {
                items = JSON.parse(dataEl.textContent || '[]');
            } catch {
                items = [];
            }

            const quotes = items.map(x => {
                const quote = (x?.quote ?? '').toString().trim();
                const source = (x?.source ?? '').toString().trim();
                return quote ? {quote, source} : null;
            }).filter(Boolean);

            const quoteBox = document.querySelector('#about-quotes .quote-text');
            const sourceBox = document.querySelector('#about-quotes .quote-source');

            if (quotes.length && quoteBox && sourceBox) {
                let i = 0;
                const delay = 5000;
                const show = (idx) => {
                    quoteBox.classList.remove('is-visible');
                    sourceBox.classList.remove('is-visible');
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            quoteBox.textContent = quotes[idx].quote;
                            sourceBox.textContent = quotes[idx].source ? `— ${quotes[idx].source}` : '';
                            if (quotes[idx].quote) quoteBox.classList.add('is-visible');
                            if (quotes[idx].source) sourceBox.classList.add('is-visible');
                        }, 120);
                    });
                };

                const next = () => {
                    i = (i + 1) % quotes.length;
                    show(i);
                };

                show(i);
                let timer = setInterval(next, delay);

                const rot = document.querySelector('#about-quotes .about-quote-rotator');
                if (rot) {
                    rot.addEventListener('mouseenter', () => clearInterval(timer));
                    rot.addEventListener('mouseleave', () => {
                        timer = setInterval(next, delay);
                    });
                }
            }
        });
    </script>

    {# existing Stripe handler (you can swap this for the mock later) #}
    <script defer>
        const stripe = Stripe("pk_test_XXXXYOUR_PUBLISHABLE_KEY");

        function handleStripeResult (result) {
            if (result.error) {
                console.error(result.error.message);
                alert(result.error.message);
            }
        }

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-buy]');
            if (!btn) return;

            const priceId = btn.dataset.priceId;
            const qty = parseInt(btn.dataset.qty || '1', 10);

            if (!priceId) {
                console.warn('Missing data-price-id on buy button');
                return;
            }

            stripe.redirectToCheckout({
                lineItems: [{price: priceId, quantity: qty}],
                mode: 'payment',
                successUrl: window.location.origin + '/checkout/success?session_id={CHECKOUT_SESSION_ID}',
                cancelUrl: window.location.origin + '/checkout/cancel'
            }).then(handleStripeResult);
        });
    </script>

{% endblock extra_scripts %}
