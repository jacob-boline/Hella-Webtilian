{# hr_shop/templates/_pm_product_panel_partial.html #}

{% if reset_option_type_panel %}
    <div id="pm-option-type-panel" hx-swap-oob="true">
        <p>Select an option type to see its values.</p>
    </div>
{% endif %}

<div class="pm-product-header">
    <form
        hx-post="{% url 'hr_shop:update_product' pk=product.pk %}"
        hx-target="#pm-product-panel"
        hx-swap="innerHTML"
        class="pm-product-edit-form"
    >
        {% csrf_token %}
        {{ product_form.non_field_errors }}
        <div>{{ product_form.name.label_tag }} {{ product_form.name }}</div>
        <div>{{ product_form.slug.label_tag }} {{ product_form.slug }}</div>
        <div>{{ product_form.description.label_tag }} {{ product_form.description }}</div>
        <button type="submit">Save Product</button>
    </form>
</div>

<div class="pm-product-columns">
    <!-- Left: option types for this product -->
    <div class="pm-product-option-types">
        <h4>Option Types</h4>

        <ul class="pm-option-type-list">
            {% for opt in option_types %}
                <li>
                    <button type="button" class="pm-option-type-button" hx-get="{% url 'hr_shop:get_manage_option_type_panel_partial' pk=opt.pk %}" hx-target="#pm-option-type-panel" hx-swap="innerHTML">
                        {{ opt.name }} ({{ opt.code }})
                    </button>
                </li>
            {% empty %}
                <li>No option types defined for this product.</li>
            {% endfor %}
        </ul>

        <h5>Add Option Type</h5>
        <form hx-post="{% url 'hr_shop:create_option_type' product_pk=product.pk %}" hx-target="#pm-product-panel" hx-swap="innerHTML" class="pm-option-type-create-form">
            {% csrf_token %}
            {{ option_type_form.non_field_errors }}
            <div>{{ option_type_form.name.label_tag }} {{ option_type_form.name }}</div>
            <div>{{ option_type_form.code.label_tag }} {{ option_type_form.code }}</div>
            <div>{{ option_type_form.position.label_tag }} {{ option_type_form.position }}</div>
            <button type="submit">Add Option Type</button>
        </form>
    </div>

    <!-- Right: variants for this product -->
    <div class="pm-product-variants">
        <h4>Variants</h4>

        <table class="pm-variant-table">
            <thead>
            <tr>
                <th>Display Variant</th>
                <th>SKU</th>
                <th>Name</th>
                <th>Price</th>
                <th>Options</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for v, v_form in variant_forms %}
                <form
                    hx-post="{% url 'hr_shop:update_variant' pk=v.pk %}"
                    hx-target="#pm-product-panel"
                    hx-swap="innerHTML"
                >
                    {% csrf_token %}
                    <tr>
                        <td>{{ v_form.is_display_variant }}</td>
                        <td>{{ v_form.sku }}</td>
                        <td>{{ v_form.name }}</td>
                        <td>{{ v_form.price }}</td>
                        <td>
                            {% for vo in v.variant_options.all %}
                                <span class="pm-variant-option-chip">
                                    {{ vo.option_value.option_type.name }}:
                                    {{ vo.option_value.name }}
                                </span>
                            {% empty %}
                                <span class="pm-variant-option-chip pm-empty">No options</span>
                            {% endfor %}
                        </td>
                        <td class="pm-variant-actions">
                            <button type="submit" class="pm-small-button">Save</button>
                            <button
                                hx-post="{% url 'hr_shop:delete_variant' pk=v.pk %}"
                                hx-target="#pm-product-panel"
                                hx-swap="innerHTML"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                type="button"
                                class="pm-small-button"
                            >
                                Delete
                            </button>
                        </td>
                    </tr>
                </form>
            {% empty %}
                <tr><td colspan="6">No variants yet.</td></tr>
            {% endfor %}
            </tbody>
        </table>

        <h5>Add Variant</h5>
        <form hx-post="{% url 'hr_shop:create_variant' product_pk=product.pk %}" hx-target="#pm-product-panel" hx-swap="innerHTML" class="pm-variant-create-form">
            {% csrf_token %}
            {{ variant_form.non_field_errors }}
            <div>{{ variant_form.sku.label_tag }} {{ variant_form.sku }}</div>
            <div>{{ variant_form.name.label_tag }} {{ variant_form.name }}</div>
            <div>{{ variant_form.price.label_tag }} {{ variant_form.price }}</div>
            <div>{{ variant_form.is_display_variant.label_tag }} {{ variant_form.is_display_variant }}</div>
            <button type="submit">Add Variant</button>
        </form>

    </div>
</div>
